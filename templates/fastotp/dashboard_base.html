{% extends 'fastotp/base.html' %}
{% block navbar %}{% endblock %}

{% block content %}
<div class="flex h-screen overflow-hidden bg-slate-50">

  <!-- Sidebar -->
  <aside class="w-64 flex-shrink-0 bg-white border-r border-slate-100 flex flex-col overflow-y-auto hidden md:flex">
    <!-- Brand -->
    <div class="p-5 border-b border-slate-100">
      <a href="{% url 'home' %}" class="flex items-center gap-2.5">
        <div class="w-8 h-8 rounded-xl bg-emerald-600 flex items-center justify-center shadow-sm">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07A19.5 19.5 0 0 1 4.69 12 19.79 19.79 0 0 1 1.56 3.56 2 2 0 0 1 3.53 1h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L7.91 8.5A16 16 0 0 0 16 16.59l.87-.88a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
        </div>
        <span class="font-display font-700 text-slate-900">FastOTP</span>
      </a>
    </div>

    <!-- User avatar -->
    <div class="p-5 border-b border-slate-100">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-2xl bg-emerald-600 flex items-center justify-center text-white font-bold text-sm shadow-sm flex-shrink-0">
          {{ request.user.avatar_initials }}
        </div>
        <div class="min-w-0">
          <p class="text-sm font-600 text-slate-800 truncate">{{ request.user.get_full_name|default:request.user.username }}</p>
          <p class="text-xs text-slate-400 truncate">{{ request.user.email }}</p>
        </div>
      </div>
    </div>

    <!-- Navigation -->
    <nav class="flex-1 p-4 space-y-1">
      <p class="text-xs font-600 text-slate-400 uppercase tracking-wider px-2 py-2">Overview</p>
      <a href="{% url 'dashboard' %}" class="sidebar-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="3" width="7" height="9" rx="1"/><rect x="14" y="3" width="7" height="5" rx="1"/><rect x="14" y="12" width="7" height="9" rx="1"/><rect x="3" y="16" width="7" height="5" rx="1"/></svg>
        Dashboard
      </a>
      <a href="{% url 'otp_logs' %}" class="sidebar-link {% if request.resolver_match.url_name == 'otp_logs' %}active{% endif %}">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
        OTP Logs
      </a>

      <p class="text-xs font-600 text-slate-400 uppercase tracking-wider px-2 py-2 mt-4">Developer</p>
      <a href="{% url 'developer' %}" class="sidebar-link {% if request.resolver_match.url_name == 'developer' %}active{% endif %}">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
        API Keys
      </a>
      <a href="#" class="sidebar-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
        Docs
      </a>

      <p class="text-xs font-600 text-slate-400 uppercase tracking-wider px-2 py-2 mt-4">Billing</p>
      <a href="{% url 'billing' %}" class="sidebar-link {% if request.resolver_match.url_name == 'billing' %}active{% endif %}">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
        Billing & Credits
      </a>

      <p class="text-xs font-600 text-slate-400 uppercase tracking-wider px-2 py-2 mt-4">Account</p>
      <a href="{% url 'account' %}" class="sidebar-link {% if request.resolver_match.url_name == 'account' %}active{% endif %}">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        Profile
      </a>
    </nav>

    <!-- Bottom: Logout -->
    <div class="p-4 border-t border-slate-100">
      <form method="POST" action="{% url 'logout' %}">
        {% csrf_token %}
        <button type="submit" class="sidebar-link w-full text-red-500 hover:bg-red-50 hover:text-red-700">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
          Sign out
        </button>
      </form>
    </div>
  </aside>

  <!-- Main content -->
  <div class="flex-1 flex flex-col overflow-hidden">
    <!-- Top bar -->
    <header class="bg-white border-b border-slate-100 h-14 flex items-center justify-between px-6 flex-shrink-0">
      <div>
        <h2 class="font-display font-600 text-slate-800 text-base">{% block page_title %}Dashboard{% endblock %}</h2>
      </div>
      <div class="flex items-center gap-4">
        <!-- Live credit badge -->
        <div id="credit-badge"
             hx-get="{% url 'credit_balance_poll' %}"
             hx-trigger="every 30s"
             hx-swap="outerHTML"
             class="flex items-center gap-2 bg-emerald-50 border border-emerald-200 px-3 py-1.5 rounded-xl">
          <span class="w-2 h-2 bg-lime-400 rounded-full animate-pulse"></span>
          <span class="text-xs font-mono font-600 text-emerald-700">
            {% if request.user.credit_balance %}
              {{ request.user.credit_balance.balance|floatformat:2 }} credits
            {% else %}0.00 credits{% endif %}
          </span>
        </div>
      </div>
    </header>

    <!-- Page body -->
    <main class="flex-1 overflow-y-auto p-6">
      {% block dashboard_content %}{% endblock %}
    </main>
  </div>
</div>

{% if messages %}
<div class="fixed top-4 right-4 z-50 space-y-2">
  {% for message in messages %}
  <div class="glass rounded-2xl px-5 py-3 flex items-center gap-3 shadow-lg border
    {% if message.tags == 'error' %}border-red-200{% else %}border-emerald-200{% endif %}
    max-w-sm" x-data="{show:true}" x-show="show" x-init="setTimeout(()=>show=false,4000)">
    <span class="text-base">{% if message.tags == 'error' %}⚠️{% else %}✅{% endif %}</span>
    <p class="text-sm font-medium text-slate-700">{{ message }}</p>
    <button @click="show=false" class="ml-auto text-slate-400"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg></button>
  </div>
  {% endfor %}
</div>
{% endif %}
{% endblock %}
